<?xml version="1.0" encoding="utf-8"?>
<!--
    Odoo Portal Models
    Copyright (C) 2025 Odoo Box
-->
<odoo>
    <data noupdate="1">
        <!-- Security rule to allow portal users to read their own leave requests -->
        <!-- Similar to hr_leave_rule_employee but for portal users -->
        <record id="hr_leave_rule_portal_read" model="ir.rule">
            <field name="name">Time Off base.group_portal read</field>
            <field name="model_id" ref="hr_holidays.model_hr_leave"/>
            <field name="domain_force">[('employee_id.user_id', '=', user.id)]</field>
            <field name="perm_create" eval="False"/>
            <field name="perm_write" eval="False"/>
            <field name="perm_unlink" eval="False"/>
            <field name="groups" eval="[(4, ref('base.group_portal'))]"/>
        </record>

        <!-- Security rule to allow portal users to create/write their own leave requests -->
        <!-- Similar to hr_leave_rule_employee_update but for portal users -->
        <record id="hr_leave_rule_portal_update" model="ir.rule">
            <field name="name">Time Off base.group_portal create/write</field>
            <field name="model_id" ref="hr_holidays.model_hr_leave"/>
            <field name="domain_force">[
                ('holiday_type', '=', 'employee'),
                '|',
                    '&amp;',
                        ('employee_id.user_id', '=', user.id),
                        ('state', 'not in', ['validate', 'validate1']),
                    '&amp;',
                        ('validation_type', 'in', ['manager', 'both', 'no_validation']),
                        ('employee_id.leave_manager_id', '=', user.id),
            ]</field>
            <field name="perm_read" eval="False"/>
            <field name="perm_unlink" eval="False"/>
            <field name="groups" eval="[(4, ref('base.group_portal'))]"/>
        </record>

        <!-- Security rule to allow portal users to delete their own draft/confirm leave requests -->
        <!-- Similar to hr_leave_rule_employee_unlink but for portal users -->
        <record id="hr_leave_rule_portal_unlink" model="ir.rule">
            <field name="name">Time Off base.group_portal unlink</field>
            <field name="model_id" ref="hr_holidays.model_hr_leave"/>
            <field name="domain_force">[('employee_id.user_id', '=', user.id), ('state', 'in', ['draft', 'confirm', 'validate1'])]</field>
            <field name="perm_read" eval="False"/>
            <field name="perm_write" eval="False"/>
            <field name="perm_create" eval="False"/>
            <field name="perm_unlink" eval="True"/>
            <field name="groups" eval="[(4, ref('base.group_portal'))]"/>
        </record>

        <!-- Security rule to allow portal users to read their own employee record -->
        <record id="hr_employee_portal_rule" model="ir.rule">
            <field name="name">Portal User: Own Employee Record</field>
            <field name="model_id" ref="hr.model_hr_employee"/>
            <field name="domain_force">[('user_id', '=', user.id)]</field>
            <field name="groups" eval="[(4, ref('base.group_portal'))]"/>
        </record>

        <!-- Security rule to allow portal users to read leave types -->
        <record id="hr_leave_type_portal_rule" model="ir.rule">
            <field name="name">Portal User: Read Leave Types</field>
            <field name="model_id" ref="hr_holidays.model_hr_leave_type"/>
            <field name="domain_force">[(1, '=', 1)]</field>
            <field name="groups" eval="[(4, ref('base.group_portal'))]"/>
        </record>

        <!-- Security rule to allow portal users to create calendar events for their own leave requests -->
        <record id="calendar_event_portal_rule" model="ir.rule">
            <field name="name">Calendar Event: Portal User Own Events</field>
            <field name="model_id" ref="calendar.model_calendar_event"/>
            <field name="domain_force">[
                '|',
                    ('user_id', '=', user.id),
                    ('partner_ids', 'in', [user.partner_id.id])
            ]</field>
            <field name="groups" eval="[(4, ref('base.group_portal'))]"/>
        </record>

        <!-- Security rule to allow portal users to create calendar attendees for their own events -->
        <record id="calendar_attendee_portal_rule" model="ir.rule">
            <field name="name">Calendar Attendee: Portal User Own Attendees</field>
            <field name="model_id" ref="calendar.model_calendar_attendee"/>
            <field name="domain_force">[
                '|',
                    ('partner_id', '=', user.partner_id.id),
                    ('event_id.user_id', '=', user.id)
            ]</field>
            <field name="groups" eval="[(4, ref('base.group_portal'))]"/>
        </record>

        <!-- Security rule to allow portal users to access mail activities assigned to them -->
        <record id="mail_activity_portal_rule" model="ir.rule">
            <field name="name">Mail Activity: Portal User Own Activities</field>
            <field name="model_id" ref="mail.model_mail_activity"/>
            <field name="domain_force">[('user_id', '=', user.id)]</field>
            <field name="groups" eval="[(4, ref('base.group_portal'))]"/>
        </record>
    </data>
</odoo>

